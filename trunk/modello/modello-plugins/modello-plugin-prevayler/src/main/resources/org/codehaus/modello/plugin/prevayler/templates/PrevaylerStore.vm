package ${package};

import java.io.Serializable;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;

import org.codehaus.plexus.personality.plexus.lifecycle.phase.Initializable;
import org.codehaus.plexus.personality.plexus.lifecycle.phase.Startable;

import org.prevayler.*;

/**
 * Generated Prevayler storage mechanism for ${model.name}.
 *
 * @author Mr Modello
 */
public class ${model.name}PrevaylerStore
    implements Initializable, Startable
{
    private String databaseDirectory;

    private Prevayler prevayler;

    private Store store;

    private static class Store
        implements Serializable
    {
#foreach ( $class in $model.allClasses )
#if ( $class.getMetadata( $storeMetadataId ).isStorable() )
        private Map ${class.name}Map = new HashMap();

        void add${class.name}( Object id, ${class.name} o ) { ${class.name}Map.put( id, o ); }

        void update${class.name}( Object id, ${class.name} o ) { ${class.name}Map.put( id, o ); }

        void delete${class.name}( Object id ) { ${class.name}Map.remove( id ); }

        ${class.name} get${class.name}( Object id ) { return (${class.name}) ${class.name}Map.get( id ); }
#end

#end
    }

#foreach ( $class in $model.allClasses )
#if ( $class.getMetadata( $storeMetadataId ).isStorable() )
    // ----------------------------------------------------------------------
    // ${class.name} Transactions
    // ----------------------------------------------------------------------

    private static class Add${class.name}
        implements TransactionWithQuery
    {
        private final Object id;

        private final ${class.name} o;

        public Add${class.name}( Object id, ${class.name} o )
        {
            this.id = id;

            this.o = o;
        }

        public Object executeAndQuery(Object prevalentSystem, Date executionTime)
            throws Exception
        {
            Store system = (Store) prevalentSystem;

            system.add${class.name}( id, o );

            return o;
        }
    }

    private static class Update${class.name}
        implements TransactionWithQuery
    {
        private final Object id;

        private final ${class.name} o;

        public Update${class.name}( Object id, ${class.name} o )
        {
            this.id = id;

            this.o = o;
        }

        public Object executeAndQuery(Object prevalentSystem, Date executionTime)
            throws Exception
        {
            Store system = (Store) prevalentSystem;

            system.update${class.name}( id, o );

            return o;
        }
    }

    private static class Delete${class.name}
        implements Transaction
    {
        private final Object id;

        public Delete${class.name}( Object id )
        {
            this.id = id;
        }

        public void executeOn( Object prevalentSystem, Date executionTime )
        {
            Store system = (Store) prevalentSystem;

            system.delete${class.name}( id );
        }
    }
#end

#end
    // ----------------------------------------------------------------------
    // Component Lifecycle
    // ----------------------------------------------------------------------

    public void initialize()
        throws Exception
    {
        prevayler = PrevaylerFactory.createPrevayler( new Store(), databaseDirectory );

        store = (Store) prevayler.prevalentSystem();
    }

    public void start()
##        throws ${model.name}StoreException
    {
    }

    public void stop()
        throws Exception
##        throws ${model.name}StoreException
    {
        prevayler.close();
    }

#foreach ( $class in $model.allClasses )
#if ( $class.getMetadata( $storeMetadataId ).isStorable() )
    // ----------------------------------------------------------------------
    // ${class.name} CRUD
    // ----------------------------------------------------------------------

    public ${class.name} add${class.name}( Object id, $class.name o )
        throws Exception
    {
        return (${class.name}) prevayler.execute( new Add${class.name}( id, o ) );
    }

    public ${class.name} update${class.name}( Object id, $class.name o )
        throws Exception
    {
        return (${class.name}) prevayler.execute( new Update${class.name}( id, o ) );
    }

    public void delete${class.name}( Object id )
        throws Exception
    {
        prevayler.execute( new Delete${class.name}( id ) );
    }

    public ${class.name} get${class.name}( Object id )
        throws Exception
    {
        return store.get${class.name}( id );
    }
#end

#end
}
